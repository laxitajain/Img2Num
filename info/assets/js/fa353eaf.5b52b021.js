"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[9189],{28453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>c});var s=i(96540);const l={},r=s.createContext(l);function d(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:d(e.components),s.createElement(r.Provider,{value:n},e.children)}},56534:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>u,frontMatter:()=>d,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"reference/wasm/modules/image/wasm-image-module","title":"CMakeLists.txt","description":"CMake configuration for building the Image WebAssembly module in Img2Num, including Emscripten build flags and module export setup.","source":"@site/docs/reference/wasm/modules/image/cmake.md","sourceDirName":"reference/wasm/modules/image","slug":"/reference/wasm/modules/image/wasm-image-module","permalink":"/Img2Num/info/docs/reference/wasm/modules/image/wasm-image-module","draft":false,"unlisted":false,"editUrl":"https://github.com/Ryan-Millard/Img2Num/edit/main/docs/docs/reference/wasm/modules/image/cmake.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"id":"wasm-image-module","title":"CMakeLists.txt","hide_title":false,"description":"CMake configuration for building the Image WebAssembly module in Img2Num, including Emscripten build flags and module export setup.","sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Image Module Overview","permalink":"/Img2Num/info/docs/reference/wasm/modules/image/overview"},"next":{"title":"bilateral_filter.h","permalink":"/Img2Num/info/docs/reference/wasm/modules/image/bilateral_filter"}}');var l=i(74848),r=i(28453);const d={id:"wasm-image-module",title:"CMakeLists.txt",hide_title:!1,description:"CMake configuration for building the Image WebAssembly module in Img2Num, including Emscripten build flags and module export setup.",sidebar_position:2},c="Image Module CMake Build Configuration",t={},o=[{value:"Module Name Setup",id:"module-name-setup",level:2},{value:"Source Files",id:"source-files",level:2},{value:"Output Configuration",id:"output-configuration",level:2},{value:"Executable Target",id:"executable-target",level:2},{value:"Include Directories",id:"include-directories",level:2},{value:"Shared Emscripten Flags",id:"shared-emscripten-flags",level:2},{value:"Applying Common Flags",id:"applying-common-flags",level:2},{value:"Build-Type Specific Flags",id:"build-type-specific-flags",level:2},{value:"Output Location and Name",id:"output-location-and-name",level:2},{value:"Summary",id:"summary",level:2}];function a(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"image-module-cmake-build-configuration",children:"Image Module CMake Build Configuration"})}),"\n",(0,l.jsxs)(n.p,{children:["This file defines the ",(0,l.jsx)(n.strong,{children:"CMake build configuration"})," for the image module in the ",(0,l.jsx)(n.strong,{children:"Img2Num"})," project.\nIt provides a cross-platform replacement for Makefiles and integrates with ",(0,l.jsx)(n.strong,{children:"Emscripten"})," to produce a ",(0,l.jsx)(n.code,{children:".wasm"})," module with a corresponding JavaScript loader."]}),"\n",(0,l.jsxs)(n.p,{children:["It was introduced in ",(0,l.jsx)(n.a,{href:"https://github.com/Ryan-Millard/Img2Num/pull/93/changes",children:"PR #93"}),"."]}),"\n",(0,l.jsx)(n.h2,{id:"module-name-setup",children:"Module Name Setup"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:'get_filename_component(MODULE_NAME ${CMAKE_CURRENT_SOURCE_DIR} NAME)\n\nstring(SUBSTRING ${MODULE_NAME} 0 1 FIRST_LETTER)\nstring(TOUPPER ${FIRST_LETTER} FIRST_LETTER_UPPER)\nstring(SUBSTRING ${MODULE_NAME} 1 -1 REST_OF_NAME)\nset(CAP_MODULE_NAME "${FIRST_LETTER_UPPER}${REST_OF_NAME}")\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"MODULE_NAME"})})," is derived from the current directory name."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"CAP_MODULE_NAME"})})," capitalizes the first letter of the module name."]}),"\n",(0,l.jsxs)(n.li,{children:["This is used for the exported JS module name: ",(0,l.jsx)(n.code,{children:"create{CAP_MODULE_NAME}Module"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Example:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Directory name: ",(0,l.jsx)(n.code,{children:"image"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"CAP_MODULE_NAME"}),": ",(0,l.jsx)(n.code,{children:"Image"})]}),"\n",(0,l.jsxs)(n.li,{children:["Export function: ",(0,l.jsx)(n.code,{children:"createImageModule()"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"source-files",children:"Source Files"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:'file(GLOB_RECURSE SRC_FILES\n    "${CMAKE_CURRENT_SOURCE_DIR}/src/*.cpp"\n)\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Collects all C++ source files recursively from ",(0,l.jsx)(n.code,{children:"src/"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Ensures that new ",(0,l.jsx)(n.code,{children:".cpp"})," files are automatically included without updating CMake manually."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"output-configuration",children:"Output Configuration"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:'set(BUILD_DIR "${CMAKE_CURRENT_SOURCE_DIR}/build")\nset(OUT_JS "${BUILD_DIR}/index.js")\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"BUILD_DIR"})})," is where the compiled ",(0,l.jsx)(n.code,{children:".wasm"})," and ",(0,l.jsx)(n.code,{children:".js"})," files will be placed."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"OUT_JS"})})," is the path to the generated JavaScript loader file."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"executable-target",children:"Executable Target"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:"add_executable(${MODULE_NAME}_wasm ${SRC_FILES})\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Creates an ",(0,l.jsx)(n.strong,{children:"Emscripten executable target"})," that produces both ",(0,l.jsx)(n.code,{children:".wasm"})," and ",(0,l.jsx)(n.code,{children:".js"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["The target is named ",(0,l.jsx)(n.code,{children:"{MODULE_NAME}_wasm"}),"."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"include-directories",children:"Include Directories"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:"target_include_directories(${MODULE_NAME}_wasm PRIVATE\n    ${CMAKE_CURRENT_SOURCE_DIR}/include\n)\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Adds the ",(0,l.jsx)(n.code,{children:"include/"})," folder for header files."]}),"\n",(0,l.jsxs)(n.li,{children:["Only visible to this target (",(0,l.jsx)(n.code,{children:"PRIVATE"}),")."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"shared-emscripten-flags",children:"Shared Emscripten Flags"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:'set(COMMON_FLAGS\n    "SHELL:-s MODULARIZE=1"\n    "SHELL:-s EXPORT_ES6=1"\n    "SHELL:-s EXIT_RUNTIME=1"\n    "SHELL:-s ENVIRONMENT=web"\n    "SHELL:-s EXPORTED_FUNCTIONS=[\'_malloc\',\'_free\']"\n    "SHELL:-s EXPORTED_RUNTIME_METHODS=[\'ccall\',\'cwrap\',\'getValue\',\'setValue\',\'HEAPU8\',\'HEAP32\']"\n    "SHELL:-s INITIAL_MEMORY=1024MB"\n    "SHELL:-s MAXIMUM_MEMORY=2048MB"\n    "SHELL:-s ALLOW_MEMORY_GROWTH=1"\n    "SHELL:-s EXPORT_NAME=create${CAP_MODULE_NAME}Module"\n)\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"MODULARIZE=1"})}),": Wraps the module in a function instead of polluting the global scope."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"EXPORT_ES6=1"})}),": Produces ES6 module syntax for imports."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"EXIT_RUNTIME=1"})}),": Ensures runtime exits cleanly when finished."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"ENVIRONMENT=web"})}),": Targets browser environment."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"EXPORTED_FUNCTIONS"})}),": Functions accessible from JS (",(0,l.jsx)(n.code,{children:"_malloc"}),", ",(0,l.jsx)(n.code,{children:"_free"}),")."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"EXPORTED_RUNTIME_METHODS"})}),": Provides Emscripten utilities like ",(0,l.jsx)(n.code,{children:"ccall"}),", ",(0,l.jsx)(n.code,{children:"cwrap"}),", and memory views."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Memory settings"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Initial: 1 GB"}),"\n",(0,l.jsx)(n.li,{children:"Max: 2 GB"}),"\n",(0,l.jsx)(n.li,{children:"Memory growth allowed"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:(0,l.jsx)(n.code,{children:"EXPORT_NAME"})}),": JS module factory function, e.g., ",(0,l.jsx)(n.code,{children:"createImageModule"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"applying-common-flags",children:"Applying Common Flags"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:"target_link_options(${MODULE_NAME}_wasm PRIVATE ${COMMON_FLAGS})\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Applies the shared flags to the link step."}),"\n",(0,l.jsx)(n.li,{children:"Ensures consistent WASM output across all modules."}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"build-type-specific-flags",children:"Build-Type Specific Flags"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:'if(CMAKE_BUILD_TYPE STREQUAL "Debug")\n    target_compile_options(${MODULE_NAME}_wasm PRIVATE -O0 -g4)\n    target_link_options(${MODULE_NAME}_wasm PRIVATE\n        "SHELL:-s ASSERTIONS=2"\n        -g4\n    )\nelse()\n    target_compile_options(${MODULE_NAME}_wasm PRIVATE -O3)\n    target_link_options(${MODULE_NAME}_wasm PRIVATE\n        "SHELL:-s SINGLE_FILE=0"\n    )\nendif()\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Debug"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["No optimizations (",(0,l.jsx)(n.code,{children:"-O0"}),")"]}),"\n",(0,l.jsxs)(n.li,{children:["Full debug info (",(0,l.jsx)(n.code,{children:"-g4"}),")"]}),"\n",(0,l.jsxs)(n.li,{children:["Emscripten runtime assertions enabled (",(0,l.jsx)(n.code,{children:"ASSERTIONS=2"}),")"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Release"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Optimized (",(0,l.jsx)(n.code,{children:"-O3"}),")"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"SINGLE_FILE=0"})," to allow separate ",(0,l.jsx)(n.code,{children:".js"})," and ",(0,l.jsx)(n.code,{children:".wasm"})," files."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["This ensures ",(0,l.jsx)(n.strong,{children:"fast builds for development"})," and ",(0,l.jsx)(n.strong,{children:"optimized output for production"}),"."]}),"\n",(0,l.jsx)(n.h2,{id:"output-location-and-name",children:"Output Location and Name"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:'set_target_properties(${MODULE_NAME}_wasm PROPERTIES\n    RUNTIME_OUTPUT_DIRECTORY "${BUILD_DIR}"\n    OUTPUT_NAME "index"\n    SUFFIX ".js"\n)\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Compiled ",(0,l.jsx)(n.code,{children:".js"})," and ",(0,l.jsx)(n.code,{children:".wasm"})," files are placed in ",(0,l.jsx)(n.code,{children:"build/"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["JS loader is always named ",(0,l.jsx)(n.code,{children:"index.js"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["WASM module is automatically named ",(0,l.jsx)(n.code,{children:"index.wasm"}),"."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,l.jsxs)(n.p,{children:["This CMake configuration provides a ",(0,l.jsx)(n.strong,{children:"self-contained build system for a single WASM module"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Automatically determines module name and export function."}),"\n",(0,l.jsx)(n.li,{children:"Collects all source files recursively."}),"\n",(0,l.jsx)(n.li,{children:"Configures Emscripten for browser-friendly ES6 modules."}),"\n",(0,l.jsx)(n.li,{children:"Handles memory allocation, runtime methods, and modularization."}),"\n",(0,l.jsxs)(n.li,{children:["Supports both ",(0,l.jsx)(n.strong,{children:"Debug"})," and ",(0,l.jsx)(n.strong,{children:"Release"})," builds."]}),"\n",(0,l.jsxs)(n.li,{children:["Produces outputs compatible with ",(0,l.jsx)(n.strong,{children:"Vite"})," and the main Img2Num workflow."]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cmake",children:"message(STATUS \"Module '${MODULE_NAME}' configured (export: create${CAP_MODULE_NAME}Module)\")\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Prints the module configuration at CMake configure time for developer visibility."}),"\n"]}),"\n",(0,l.jsx)(n.mermaid,{value:'flowchart TD\n    A["Start CMake for Module"] --\x3e B["Determine MODULE_NAME and CAP_MODULE_NAME"]\n    B --\x3e C["Collect source files from src/"]\n    C --\x3e D["Create Emscripten executable target"]\n    D --\x3e E["Apply include directories"]\n    E --\x3e F["Apply common Emscripten flags"]\n    F --\x3e G{"Build type?"}\n    G --\x3e|Debug| H["Compile with -O0, debug info, ASSERTIONS=2"]\n    G --\x3e|Release| I["Compile with -O3, SINGLE_FILE=0"]\n    H --\x3e J["Set output directory and name (build/index.js)"]\n    I --\x3e J\n    J --\x3e K["Generate JS loader and WASM module"]\n    K --\x3e L["Module ready for Vite import (@wasm-{module})"]'}),"\n",(0,l.jsx)(n.admonition,{title:"Vite Import",type:"info",children:(0,l.jsxs)(n.p,{children:["See the ",(0,l.jsx)(n.a,{href:"../../../../react/vite-config/",children:"Vite configuration documentation"})," to understand how Vite imports it."]})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}}}]);