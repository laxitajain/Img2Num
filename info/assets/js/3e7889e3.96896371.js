"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[6611],{28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>l});var t=s(96540);const i={},r=t.createContext(i);function o(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:n},e.children)}},68407:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"reference/wasm/wasm-dev-workflow","title":"Development workflow & watch behavior","description":"This repository configures a Vite plugin (watch-cpp-and-build-wasm) that watches .cpp and .h files and runs npm run build-wasm when changes occur. The plugin logic prevents overlapping builds with a isBuilding flag.","source":"@site/docs/reference/wasm/development-workflow.md","sourceDirName":"reference/wasm","slug":"/reference/wasm/wasm-dev-workflow","permalink":"/Img2Num/info/docs/reference/wasm/wasm-dev-workflow","draft":false,"unlisted":false,"editUrl":"https://github.com/Ryan-Millard/Img2Num/edit/main/docs/docs/reference/wasm/development-workflow.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"id":"wasm-dev-workflow","title":"Development workflow & watch behavior","sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Using WASM modules in React","permalink":"/Img2Num/info/docs/reference/wasm/wasm-using-react"},"next":{"title":"Troubleshooting & size/ perf optimizations","permalink":"/Img2Num/info/docs/reference/wasm/wasm-troubleshooting"}}');var i=s(74848),r=s(28453);const o={id:"wasm-dev-workflow",title:"Development workflow & watch behavior",sidebar_position:4},l="Dev server & automatic rebuilds",c={},d=[{value:"Root CMakeLists.txt contract",id:"root-cmakeliststxt-contract",level:2},{value:"Example submodule CMakeLists.txt template (recommended)",id:"example-submodule-cmakeliststxt-template-recommended",level:2},{value:"Debugging tips",id:"debugging-tips",level:2}];function a(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"dev-server--automatic-rebuilds",children:"Dev server & automatic rebuilds"})}),"\n",(0,i.jsxs)(n.p,{children:["This repository configures a Vite plugin (",(0,i.jsx)(n.code,{children:"watch-cpp-and-build-wasm"}),") that watches ",(0,i.jsx)(n.code,{children:".cpp"})," and ",(0,i.jsx)(n.code,{children:".h"})," files and runs ",(0,i.jsx)(n.code,{children:"npm run build-wasm"})," when changes occur. The plugin logic prevents overlapping builds with a ",(0,i.jsx)(n.code,{children:"__isBuilding"})," flag."]}),"\n",(0,i.jsx)(n.p,{children:"Important points:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The watcher registers ",(0,i.jsx)(n.code,{children:"src/wasm/**/*.{cpp,h}"})," with Vite's watcher so edits trigger rebuilds."]}),"\n",(0,i.jsxs)(n.li,{children:["The build uses the root ",(0,i.jsx)(n.code,{children:"src/wasm/CMakeLists.txt"})," which iterates through the modules and calls each module's ",(0,i.jsx)(n.code,{children:"CMakeLists.txt"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["For faster local iteration use ",(0,i.jsx)(n.code,{children:"npm run dev:debug"})," \u2014 this runs ",(0,i.jsx)(n.code,{children:"make debug"})," and launches the dev server."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"root-cmakeliststxt-contract",children:"Root CMakeLists.txt contract"}),"\n",(0,i.jsxs)(n.p,{children:["The root ",(0,i.jsx)(n.code,{children:"src/wasm/CMakeLists.txt"})," (provided in the repo) implements two main targets, ",(0,i.jsx)(n.code,{children:"build"})," & ",(0,i.jsx)(n.code,{children:"debug"}),".\nSubmodule CMakeLists.txt must therefore support at least ",(0,i.jsx)(n.code,{children:"build"})," (default) & ",(0,i.jsx)(n.code,{children:"debug"})," targets."]}),"\n",(0,i.jsx)(n.h2,{id:"example-submodule-cmakeliststxt-template-recommended",children:"Example submodule CMakeLists.txt template (recommended)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-CMakeLists.txt",children:'# =================================================================\n# <ModuleName> WASM Module - CMake Build Configuration\n# =================================================================\n\n# Get module name from directory\nget_filename_component(MODULE_NAME ${CMAKE_CURRENT_SOURCE_DIR} NAME)\n\n# Capitalize first letter for export name (e.g., "example" -> "Example")\nstring(SUBSTRING ${MODULE_NAME} 0 1 FIRST_LETTER)\nstring(TOUPPER ${FIRST_LETTER} FIRST_LETTER_UPPER)\nstring(SUBSTRING ${MODULE_NAME} 1 -1 REST_OF_NAME)\nset(CAP_MODULE_NAME "${FIRST_LETTER_UPPER}${REST_OF_NAME}")\n\n# Collect source files (recursively)\nfile(GLOB_RECURSE SRC_FILES\n    "${CMAKE_CURRENT_SOURCE_DIR}/src/*.cpp"\n)\n\n# Output directory\nset(BUILD_DIR "${CMAKE_CURRENT_SOURCE_DIR}/build")\nset(OUT_JS "${BUILD_DIR}/index.js")\n\n# Create executable target (Emscripten produces .js + .wasm)\nadd_executable(${MODULE_NAME}_wasm ${SRC_FILES})\n\n# Include directories\ntarget_include_directories(${MODULE_NAME}_wasm PRIVATE\n    ${CMAKE_CURRENT_SOURCE_DIR}/include\n)\n\n# Shared Emscripten options\nset(COMMON_FLAGS\n    "SHELL:-s MODULARIZE=1"\n    "SHELL:-s EXPORT_ES6=1"\n    "SHELL:-s EXIT_RUNTIME=1"\n    "SHELL:-s ENVIRONMENT=web"\n    "SHELL:-s EXPORTED_FUNCTIONS=[\'_malloc\',\'_free\']"\n    "SHELL:-s EXPORTED_RUNTIME_METHODS=[\'ccall\',\'cwrap\',\'getValue\',\'setValue\',\'HEAPU8\']"\n    "SHELL:-s INITIAL_MEMORY=1024MB"\n    "SHELL:-s MAXIMUM_MEMORY=2048MB"\n    "SHELL:-s ALLOW_MEMORY_GROWTH=1"\n    "SHELL:-s EXPORT_NAME=create${CAP_MODULE_NAME}Module"\n)\n\n# Apply common flags\ntarget_link_options(${MODULE_NAME}_wasm PRIVATE ${COMMON_FLAGS})\n\n# Build-type specific flags\nif(CMAKE_BUILD_TYPE STREQUAL "Debug")\n    target_compile_options(${MODULE_NAME}_wasm PRIVATE -O0 -g4)\n    target_link_options(${MODULE_NAME}_wasm PRIVATE\n        "SHELL:-s ASSERTIONS=2"\n        -g4\n    )\nelse()\n    target_compile_options(${MODULE_NAME}_wasm PRIVATE -O3)\n    target_link_options(${MODULE_NAME}_wasm PRIVATE\n        "SHELL:-s SINGLE_FILE=0"\n    )\nendif()\n\n# Set output location and name\nset_target_properties(${MODULE_NAME}_wasm PROPERTIES\n    RUNTIME_OUTPUT_DIRECTORY "${BUILD_DIR}"\n    OUTPUT_NAME "index"\n    SUFFIX ".js"\n)\n\nmessage(STATUS "Module \'${MODULE_NAME}\' configured (export: create${CAP_MODULE_NAME}Module)")\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Place your C++ headers in include/ and sources in src/"}),"\n",(0,i.jsx)(n.li,{children:"Use exported functions via ccall/cwrap in JS"}),"\n",(0,i.jsx)(n.li,{children:"Adjust memory flags if your module needs more/less WASM memory"}),"\n",(0,i.jsx)(n.li,{children:"For module-specific Emscripten options, add them before target_link_options"}),"\n"]})}),"\n",(0,i.jsxs)(n.p,{children:["This template compiles all ",(0,i.jsx)(n.code,{children:".cpp"})," files under ",(0,i.jsx)(n.code,{children:"src/"})," into ",(0,i.jsx)(n.code,{children:"build/index.js"})," + ",(0,i.jsx)(n.code,{children:"build/index.wasm"})," using simple flags. Tailor flags and link-time options to your needs."]}),"\n",(0,i.jsx)(n.h2,{id:"debugging-tips",children:"Debugging tips"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Build with ",(0,i.jsx)(n.code,{children:"debug"})," target to keep symbols and turn on ",(0,i.jsx)(n.code,{children:"ASSERTIONS"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Use ",(0,i.jsx)(n.code,{children:"EMSCRIPTEN_KEEP_UNWANTED_CODE"})," only when you need to preserve functions \u2014 avoid it in production."]}),"\n",(0,i.jsxs)(n.li,{children:["Use ",(0,i.jsx)(n.code,{children:"console.log"})," in Emscripten glue JS \u2014 Emscripten prints useful warnings if symbols are missing."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);