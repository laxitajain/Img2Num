"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[7491],{28453:(e,i,s)=>{s.d(i,{R:()=>l,x:()=>d});var n=s(96540);const o={},r=n.createContext(o);function l(e){const i=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function d(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),n.createElement(r.Provider,{value:i},e.children)}},73883:(e,i,s)=>{s.r(i),s.d(i,{assets:()=>t,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"reference/wasm/wasm-troubleshooting","title":"Troubleshooting & size/ perf optimizations","description":"The browser fails to load .wasm with 404/incorrect MIME type","source":"@site/docs/reference/wasm/troubleshooting-and-optimizations.md","sourceDirName":"reference/wasm","slug":"/reference/wasm/wasm-troubleshooting","permalink":"/Img2Num/info/docs/reference/wasm/wasm-troubleshooting","draft":false,"unlisted":false,"editUrl":"https://github.com/Ryan-Millard/Img2Num/edit/main/docs/docs/reference/wasm/troubleshooting-and-optimizations.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"id":"wasm-troubleshooting","title":"Troubleshooting & size/ perf optimizations","sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Development workflow & watch behavior","permalink":"/Img2Num/info/docs/reference/wasm/wasm-dev-workflow"},"next":{"title":"Adding a new WASM module","permalink":"/Img2Num/info/docs/reference/wasm/wasm-add-module"}}');var o=s(74848),r=s(28453);const l={id:"wasm-troubleshooting",title:"Troubleshooting & size/ perf optimizations",sidebar_position:5},d="Troubleshooting",t={},c=[{value:"The browser fails to load <code>.wasm</code> with <code>404</code>/<code>incorrect MIME type</code>",id:"the-browser-fails-to-load-wasm-with-404incorrect-mime-type",level:2},{value:"Hot reload doesn&#39;t pick up changes",id:"hot-reload-doesnt-pick-up-changes",level:2},{value:"Large <code>.wasm</code> size",id:"large-wasm-size",level:2},{value:"Optimizations checklist",id:"optimizations-checklist",level:2},{value:"CI &amp; reproducible builds",id:"ci--reproducible-builds",level:2},{value:"If builds hang or fail on Windows",id:"if-builds-hang-or-fail-on-windows",level:2}];function a(e){const i={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(i.header,{children:(0,o.jsx)(i.h1,{id:"troubleshooting",children:"Troubleshooting"})}),"\n",(0,o.jsxs)(i.h2,{id:"the-browser-fails-to-load-wasm-with-404incorrect-mime-type",children:["The browser fails to load ",(0,o.jsx)(i.code,{children:".wasm"})," with ",(0,o.jsx)(i.code,{children:"404"}),"/",(0,o.jsx)(i.code,{children:"incorrect MIME type"})]}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:["Vite copies ",(0,o.jsx)(i.code,{children:".wasm"})," to the ",(0,o.jsx)(i.code,{children:"dist"})," when ",(0,o.jsx)(i.code,{children:"assetsInclude"})," includes ",(0,o.jsx)(i.code,{children:"**/*.wasm"}),".\nWhen you serve the built app, ensure the files were published and the ",(0,o.jsx)(i.code,{children:"base"})," in ",(0,o.jsx)(i.code,{children:"vite.config.js"})," is correct (this repo uses ",(0,o.jsx)(i.code,{children:"/Img2Num/"}),")."]}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"hot-reload-doesnt-pick-up-changes",children:"Hot reload doesn't pick up changes"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:["Confirm the plugin added the files to ",(0,o.jsx)(i.code,{children:"server.watcher"}),". If not, open ",(0,o.jsx)(i.code,{children:"vite.config.js"})," and verify ",(0,o.jsx)(i.code,{children:"fg.sync('src/wasm/**/*.{cpp,h}')"})," returns your files."]}),"\n",(0,o.jsxs)(i.li,{children:["Ensure the watcher is not ignoring the paths (see ",(0,o.jsx)(i.code,{children:"server.watch.ignored"})," in ",(0,o.jsx)(i.code,{children:"vite.config.js"}),")."]}),"\n"]}),"\n",(0,o.jsxs)(i.h2,{id:"large-wasm-size",children:["Large ",(0,o.jsx)(i.code,{children:".wasm"})," size"]}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:["Use ",(0,o.jsx)(i.code,{children:"-O3"})," with ",(0,o.jsx)(i.code,{children:"--closure 1"})," or ",(0,o.jsx)(i.code,{children:"-Os"})," depending on your performance/size tradeoffs."]}),"\n",(0,o.jsxs)(i.li,{children:["Strip debug symbols for production builds (",(0,o.jsx)(i.code,{children:"-s DEMANGLE_SUPPORT=0"})," and remove ",(0,o.jsx)(i.code,{children:"-g"}),")."]}),"\n",(0,o.jsxs)(i.li,{children:["Use ",(0,o.jsx)(i.code,{children:"-s ALLOW_MEMORY_GROWTH=1"})," only if necessary; fixed memory can be slightly smaller."]}),"\n",(0,o.jsxs)(i.li,{children:["Audit exported functions \u2014 export only what you need via ",(0,o.jsx)(i.code,{children:"EXPORTED_FUNCTIONS"})," or ",(0,o.jsx)(i.code,{children:"EMSCRIPTEN_BINDINGS"}),"."]}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"optimizations-checklist",children:"Optimizations checklist"}),"\n",(0,o.jsxs)(i.ol,{children:["\n",(0,o.jsxs)(i.li,{children:["Build release with ",(0,o.jsx)(i.code,{children:"-O3"})," and closure compiler. Example flag additions:","\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{children:'emcc ... \\\n  -O3 \\\n  --closure 1 \\\n  -s ALLOW_MEMORY_GROWTH=0 \\\n  -s MODULARIZE=1 \\\n  -s EXPORT_NAME="createModule"\n'})}),"\n"]}),"\n",(0,o.jsxs)(i.li,{children:["Use ",(0,o.jsx)(i.code,{children:"MODULARIZE"})," and ",(0,o.jsx)(i.code,{children:"EXPORT_NAME"})," to control loader behavior and reduce global pollution."]}),"\n",(0,o.jsxs)(i.li,{children:["Use ",(0,o.jsx)(i.strong,{children:"lazy instantiation"}),": only instantiate the WASM module in components that need it."]}),"\n",(0,o.jsx)(i.li,{children:"Consider splitting functionality into multiple modules to avoid shipping large monolithic WASM files."}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"ci--reproducible-builds",children:"CI & reproducible builds"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:["In CI, install a pinned emsdk version and call ",(0,o.jsx)(i.code,{children:"npm run build-wasm"})," (or ",(0,o.jsx)(i.code,{children:"make -C src/wasm build"}),")."]}),"\n",(0,o.jsx)(i.li,{children:"Cache the emsdk install between CI runs to save time."}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"if-builds-hang-or-fail-on-windows",children:"If builds hang or fail on Windows"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:"Run builds inside WSL2 or use a cross-platform Docker image that has emsdk preinstalled."}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,o.jsx)(i,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}}}]);