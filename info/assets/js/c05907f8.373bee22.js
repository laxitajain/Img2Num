"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[4617],{28453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>a});var s=r(96540);const i={},l=s.createContext(i);function o(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(l.Provider,{value:n},e.children)}},78427:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"reference/react/workers/wasm-worker","title":"WASM Worker for Image Module","description":"A Web Worker that interfaces with the Image WebAssembly module, handling TypedArray memory allocation, function calls, and returning results.","source":"@site/docs/reference/react/workers/wasmWorker.md","sourceDirName":"reference/react/workers","slug":"/reference/react/workers/wasm-worker","permalink":"/Img2Num/info/docs/reference/react/workers/wasm-worker","draft":false,"unlisted":false,"editUrl":"https://github.com/Ryan-Millard/Img2Num/edit/main/docs/docs/reference/react/workers/wasmWorker.md","tags":[],"version":"current","frontMatter":{"id":"wasm-worker","title":"WASM Worker for Image Module","hide_title":false,"description":"A Web Worker that interfaces with the Image WebAssembly module, handling TypedArray memory allocation, function calls, and returning results."},"sidebar":"tutorialSidebar","previous":{"title":"Workers","permalink":"/Img2Num/info/docs/reference/react/workers"},"next":{"title":"WebAssembly (WASM)","permalink":"/Img2Num/info/docs/reference/wasm"}}');var i=r(74848),l=r(28453);const o={id:"wasm-worker",title:"WASM Worker for Image Module",hide_title:!1,description:"A Web Worker that interfaces with the Image WebAssembly module, handling TypedArray memory allocation, function calls, and returning results."},a=void 0,t={},c=[{value:"Overview",id:"overview",level:2},{value:"Key responsibilities",id:"key-responsibilities",level:3},{value:"WASM Module Initialization",id:"wasm-module-initialization",level:2},{value:"Message Handling",id:"message-handling",level:2},{value:"Memory Allocation for TypedArrays",id:"memory-allocation-for-typedarrays",level:2},{value:"Dynamic WASM Function Call",id:"dynamic-wasm-function-call",level:2},{value:"Reading Back Modified Buffers",id:"reading-back-modified-buffers",level:2},{value:"Memory Cleanup",id:"memory-cleanup",level:2},{value:"Posting Results Back",id:"posting-results-back",level:2},{value:"Diagram (WASM Worker Flow)",id:"diagram-wasm-worker-flow",level:2}];function d(e){const n={admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["This file implements a ",(0,i.jsx)(n.strong,{children:"Web Worker"})," that acts as a bridge between JavaScript and the ",(0,i.jsx)(n.strong,{children:"Image WASM module"}),".\nIt handles ",(0,i.jsx)(n.strong,{children:"memory allocation"}),", ",(0,i.jsx)(n.strong,{children:"TypedArray mapping"}),", ",(0,i.jsx)(n.strong,{children:"dynamic function calls"}),", and ",(0,i.jsx)(n.strong,{children:"returning results or errors"})," asynchronously."]}),"\n",(0,i.jsx)(n.p,{children:"This allows expensive WASM computations to run independently from the main thread, improving UI performance."}),"\n",(0,i.jsxs)(n.admonition,{title:"JS-to-WASM Memory",type:"tip",children:[(0,i.jsx)(n.p,{children:"To ensure safety and proper memory management, all data is copied between JavaScript and WASM."}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["JavaScript receives a ",(0,i.jsx)(n.strong,{children:"detached copy"}),", allowing its garbage collector (GC) to clean up unused objects."]}),"\n",(0,i.jsx)(n.li,{children:"WASM manages its own memory independently, preventing accidental overwrites or leaks."}),"\n"]}),(0,i.jsx)(n.p,{children:"This pattern avoids bugs that could occur if JS arrays directly referenced WASM memory that gets freed."})]}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.h3,{id:"key-responsibilities",children:"Key responsibilities"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Load and initialize the ",(0,i.jsx)(n.strong,{children:"Image WASM module"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Accept messages from the main thread describing:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The function to call in WASM."}),"\n",(0,i.jsx)(n.li,{children:"Arguments to pass (including TypedArrays)."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Allocate and copy memory for JS arrays into WASM."}),"\n",(0,i.jsx)(n.li,{children:"Invoke the WASM function dynamically."}),"\n",(0,i.jsx)(n.li,{children:"Read back any modified buffers from WASM memory."}),"\n",(0,i.jsxs)(n.li,{children:["Free allocated memory to prevent leaks.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"This keeps the code written in JavaScript looking more like JavaScript and prevents forgotten memory frees."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Post results or errors back to the main thread."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"wasm-module-initialization",children:"WASM Module Initialization"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"import createImageModule from '@wasm-image';\n\nlet wasmModule;\nlet readyResolve;\nconst readyPromise = new Promise((res) => (readyResolve = res));\n\n// Initialize the module once\ncreateImageModule().then((mod) => {\n  wasmModule = mod;\n  readyResolve();\n});\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Imports the ",(0,i.jsx)(n.code,{children:"createImageModule"})," factory function generated by ",(0,i.jsx)(n.strong,{children:"Emscripten"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Uses a ",(0,i.jsx)(n.strong,{children:"Promise"})," (",(0,i.jsx)(n.code,{children:"readyPromise"}),") to ensure the module is fully loaded before handling any messages."]}),"\n",(0,i.jsx)(n.li,{children:"Initialization only happens once."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"message-handling",children:"Message Handling"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"self.onmessage = async ({ data }) => {\n  await readyPromise;\n\n  const { id, funcName, args, bufferKeys } = data;\n  const pointers = Object.create(null); // Track malloc pointers\n  try {\n    // Allocate buffers for Array payloads\n    ...\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["The worker listens to ",(0,i.jsx)(n.code,{children:"self.onmessage"})," from the main thread."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Each message should contain:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": Unique identifier for correlating responses."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"funcName"}),": WASM function to call."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"args"}),": Object containing arguments."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"bufferKeys"})," (optional): Keys in ",(0,i.jsx)(n.code,{children:"args"})," that are TypedArrays and require special WASM memory mapping."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["The worker waits for the WASM module to be ",(0,i.jsx)(n.strong,{children:"ready"})," before proceeding."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"memory-allocation-for-typedarrays",children:"Memory Allocation for TypedArrays"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"if (bufferKeys) {\n  for (const key of bufferKeys) {\n    const arr = args[key];\n    const sizeInBytes = arr.byteLength;\n    const ptr = wasmModule._malloc(sizeInBytes);\n\n    if (arr instanceof Int32Array) {\n      wasmModule.HEAP32.set(arr, ptr / Int32Array.BYTES_PER_ELEMENT);\n    } else if (arr instanceof Uint8ClampedArray || arr instanceof Uint8Array) {\n      wasmModule.HEAPU8.set(arr, ptr);\n    } else {\n      throw new Error(`Unsupported TypedArray type for key: ${key}`);\n    }\n\n    pointers[key] = { ptr, sizeInBytes, type: arr.constructor };\n    args[key] = ptr; // pass pointer to WASM\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["For each buffer key:","\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Allocate memory in WASM using ",(0,i.jsx)(n.code,{children:"_malloc"})," (C-style code applies here for interoperability, this is why the ",(0,i.jsx)(n.code,{children:"new"})," keyword from C++ is not used)."]}),"\n",(0,i.jsxs)(n.li,{children:["Copy the JS array into the appropriate ",(0,i.jsx)(n.strong,{children:"HEAP view"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Int32Array"})," \u2192 ",(0,i.jsx)(n.code,{children:"HEAP32"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Uint8ClampedArray"})," \u2192 ",(0,i.jsx)(n.code,{children:"HEAPU8"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Uint8Array"})," \u2192 ",(0,i.jsx)(n.code,{children:"HEAPU8"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Replace the JS array in ",(0,i.jsx)(n.code,{children:"args"})," with the pointer."]}),"\n",(0,i.jsx)(n.li,{children:"Track allocation for later cleanup."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.admonition,{title:"Danger: New TypedArray Types",type:"danger",children:[(0,i.jsxs)(n.p,{children:["Any new TypedArray types must be added to this section and their corresponding ",(0,i.jsx)(n.strong,{children:"EXPORTED_RUNTIME_METHODS"})," in the C++ module's CMake build file."]}),(0,i.jsxs)(n.p,{children:["For example, an ",(0,i.jsx)(n.code,{children:"Int32Array"})," cannot be read if ",(0,i.jsx)(n.code,{children:"HEAP32"})," is not exported from WASM. This means that it needs to be exported explicitly in the CMake file."]})]}),"\n",(0,i.jsx)(n.h2,{id:"dynamic-wasm-function-call",children:"Dynamic WASM Function Call"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const exportName = `_${funcName}`;\nif (typeof wasmModule[exportName] !== 'function') {\n  throw new Error(`WASM export not found: ${exportName}`);\n}\n\nconst targetFunction = wasmModule[exportName];\nconst targetFunctionArgs = funcName && args ? Object.values(args) : [];\nconst result = targetFunction(...targetFunctionArgs);\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["All Emscripten exports are prefixed with ",(0,i.jsx)(n.code,{children:"_"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"We add the prefix in the API for the caller's convenience because it is easy to forget."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Uses ",(0,i.jsx)(n.strong,{children:"dynamic lookup"})," so any exported function can be called."]}),"\n",(0,i.jsxs)(n.li,{children:["Arguments are passed as an ",(0,i.jsx)(n.strong,{children:"array of values or pointers"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"reading-back-modified-buffers",children:"Reading Back Modified Buffers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const outputs = {};\nif (bufferKeys) {\n  for (const key of bufferKeys) {\n    const { ptr, sizeInBytes, type } = pointers[key];\n    if (type === Int32Array) {\n      outputs[key] = new Int32Array(wasmModule.HEAP32.buffer, ptr, sizeInBytes / Int32Array.BYTES_PER_ELEMENT).slice();\n    } else if (type === Uint8ClampedArray) {\n      outputs[key] = new Uint8ClampedArray(wasmModule.HEAPU8.subarray(ptr, ptr + sizeInBytes)).slice();\n    } else if (type === Uint8Array) {\n      outputs[key] = new Uint8Array(wasmModule.HEAPU8.subarray(ptr, ptr + sizeInBytes)).slice();\n    }\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"After the function call, reads back any modified arrays."}),"\n",(0,i.jsxs)(n.li,{children:["Uses ",(0,i.jsx)(n.code,{children:".slice()"})," to detach from WASM memory."]}),"\n",(0,i.jsxs)(n.li,{children:["Ensures main thread receives ",(0,i.jsx)(n.strong,{children:"independent copies"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"memory-cleanup",children:"Memory Cleanup"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"finally {\n  for (const { ptr } of Object.values(pointers)) {\n    wasmModule._free(ptr);\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Always frees allocated memory with ",(0,i.jsx)(n.code,{children:"_free"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Prevents memory leaks in long-running workers."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"posting-results-back",children:"Posting Results Back"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"self.postMessage({ id, output: outputs, returnValue: result });\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Returns both:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"returnValue"}),": the function\u2019s direct return value."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"output"}),": object containing updated TypedArrays."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"If any error occurs, it posts back:"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"self.postMessage({ id, error: error.message });\n"})}),"\n",(0,i.jsx)(n.h2,{id:"diagram-wasm-worker-flow",children:"Diagram (WASM Worker Flow)"}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart TD\n    A["Main Thread posts message"] --\x3e B["Worker receives message"]\n    B --\x3e C["Wait for WASM module ready"]\n    C --\x3e D["Allocate memory for TypedArrays in HEAP"]\n    D --\x3e E["Copy JS arrays into WASM memory"]\n    E --\x3e F["Call WASM function dynamically"]\n    F --\x3e G["Read back modified buffers"]\n    G --\x3e H["Free allocated memory"]\n    H --\x3e I["Post result or error back to main thread"]'}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Shows the ",(0,i.jsx)(n.strong,{children:"end-to-end flow"})," of handling a message:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"JS array \u2192 WASM memory \u2192 function call \u2192 output \u2192 free memory \u2192 return to main thread."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"Notes for Developers",type:"info",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Always add ",(0,i.jsx)(n.strong,{children:"new TypedArray types"})," in both:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["This worker file (",(0,i.jsx)(n.code,{children:"wasmWorker.js"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["The Emscripten module\u2019s ",(0,i.jsx)(n.code,{children:"EXPORTED_RUNTIME_METHODS"})," in CMake."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Avoid calling WASM functions before the module is fully initialized."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"bufferKeys"})})," to specify which arguments are arrays needing memory allocation."]}),"\n"]}),"\n"]})})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);